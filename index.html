<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script
      src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"
      type="text/javascript"
    ></script>
  </head>
  <body style="font-family: sans-serif; background: #f4f4f4; text-align: center; padding: 40px;">
    <h2>Calendar Event Generator</h2>
    <p>Waiting for event details from Thunkable...</p>
  </body>

  <script>
    // Function to generate ICS file content
    function createICS(eventName, eventDate) {
      // Convert to YYYYMMDDTHHMMSSZ (UTC format)
      const formattedDate = eventDate.replace(/[-:]/g, '').split('.')[0] + 'Z';

      return `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${eventName}
DTSTART:${formattedDate}
DTEND:${formattedDate}
DESCRIPTION:Event from Thunkable App
END:VEVENT
END:VCALENDAR`;
    }

    // Listen for messages from Thunkable
    ThunkableWebviewerExtension.receiveMessage(function (message) {
      try {
        const msg = JSON.parse(message);

        if (msg.type === "createEvent") {
          const { eventName, eventDate } = msg;

          // Generate ICS file
          const icsContent = createICS(eventName, eventDate);
          const blob = new Blob([icsContent], { type: "text/calendar" });
          const url = URL.createObjectURL(blob);

          // Force download/open
          const a = document.createElement("a");
          a.href = url;
          a.download = `${eventName}.ics`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          URL.revokeObjectURL(url);

          // Notify Thunkable
          ThunkableWebviewerExtension.postMessage(
            JSON.stringify({ status: "success", event: eventName })
          );
        }
      } catch (e) {
        console.error("Invalid message:", e);
        ThunkableWebviewerExtension.postMessage(
          JSON.stringify({ status: "error", message: e.message })
        );
      }
    });

    // Let Thunkable know the page is ready
    ThunkableWebviewerExtension.postMessage(
      JSON.stringify({ status: "ready" })
    );
  </script>
</html>